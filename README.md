# Meta Project

# Система управления пользователями и аудита на Django

Этот проект на Django предоставляет систему управления пользователями с функционалом регистрации, аутентификации, управления профилем и логирования входов. Используется Django REST Framework (DRF) для создания API, кастомная модель пользователя и отдельная база данных для логов аудита.

## Основные возможности

- **Управление пользователями**:
  - Кастомная модель пользователя (`CustomUser`) с email в качестве основного идентификатора.
  - Регистрация пользователей с активацией по email.
  - Получение и обновление профиля для аутентифицированных пользователей.
  - Аутентификация на основе JWT с использованием `rest_framework_simplejwt`.
  - Создание суперпользователя с автоматической активацией.

- **Логирование аудита**:
  - Отслеживание входов пользователей (ID пользователя, email, время, IP-адрес, пользовательский агент).
  - Хранение логов аудита в отдельной базе данных (`audit`) с использованием маршрутизатора баз данных.
  - API-эндпоинт для просмотра логов входов для аутентифицированных пользователей с фильтрацией и сортировкой.

- **Активация по email**:
  - Отправка писем с уникальным кодом активации на основе UUID.
  - Перенаправление на указанный URL (например, Google) после успешной активации.

## Структура проекта

- **account/**: Управление функционалом пользователей.
  - `admin.py`: Регистрация модели `CustomUser` в админ-панели Django.
  - `db_router.py`: Маршрутизатор базы данных для направления операций аудита в базу `audit`.
  - `models.py`: Определение кастомной модели `CustomUser`, расширяющей `AbstractUser`.
  - `manager.py`: Кастомный менеджер пользователей для создания пользователей и суперпользователей.
  - `send_email.py`: Утилита для отправки писем с активацией.
  - `serializers.py`: Сериализаторы для регистрации и управления профилем.
  - `urls.py`: API-эндпоинты для регистрации, профиля, получения токена, обновления токена и активации.
  - `views.py`: Представления API для регистрации, управления профилем, генерации токенов и активации.

- **audit/**: Управление логированием входов.
  - `admin.py`: Регистрация модели `LoginLog` в админ-панели Django.
  - `models.py`: Определение модели `LoginLog` для хранения данных о входах.
  - `serializers.py`: Сериализатор для данных логов входов.
  - `urls.py`: API-эндпоинт для просмотра логов входов.
  - `views.py`: Представление API для получения логов входов с фильтрацией и сортировкой.

## Требования

- Python 3.8+
- Django 4.x
- Django REST Framework
- djangorestframework-simplejwt - для регистрации и jwt токенов
- psycopg2-binary - для работы psql
- python-decouple - для сокрытие данных
- django-filter - фильтарция 
- Настроенный почтовый сервер для отправки писем активации
- Две базы данных (например, PostgreSQL, SQLite) для `default` и `audit`

## Установка

1. **Клонируйте репозиторий**:
   ```bash
   git clone <url-репозитория>
   cd <директория-проекта>

2. Создать и активировать виртуальное окружение:
```bash
python3 -m venv venv
source venv/bin/activate  # Linux/macOS
venv\Scripts\activate     # Windows
```

3. Установить зависимости:
```bash
pip install -r req.txt
```

4. Настроить `.env` файл:
```
DB_NAME_MAIN=your_main_db
DB_NAME_AUDIT=audit_db
DB_USER=your_user
DB_PASSWORD=your_password
DB_HOST=localhost
DB_PORT=5432
HOST_FOR_SEND_MAIL=http://localhost:8000
```

5. Применить миграции:
```bash
./manage.py makemigrations
./manage.py migrate
./manage.py migrate --database=audit
```

6. Создать суперпользователя:
```bash
./manage.py createsuperuser
```

## Структура проекта

- `account/` - приложения для управления пользователями
  - `models.py` - модель `CustomUser`
  - `manager.py` - кастомный менеджер пользователей
  - `serializers.py` - сериализаторы для регистрации и профиля
  - `views.py` - API представления для регистрации, профиля, токенов и активации
  - `urls.py` - маршруты API
  - `db_router.py` - роутер для разделения баз данных
- `audit/` - приложение для логирования входов
  - `models.py` - модель `LoginLog`
  - `serializers.py` - сериализатор `LoginLog`
  - `views.py` - API для получения логов
  - `urls.py` - маршруты API
  - `admin.py` - отображение логов в Django admin

## Эндпоинты API

### Account
| Эндпоинт | Метод | Назначение |
|-----------|-------|------------|
| `/api/v1/users/register/` | POST | Регистрация пользователя |
| `/api/v1/users/token/` | POST | Получение JWT токена |
| `/api/v1/users/token/refresh/` | POST | Обновление JWT токена |
| `/api/v1/users/me/` | GET/PUT | Получение/обновление профиля |
| `/api/v1/users/activate/` | GET | Активация пользователя по коду |

### Audit
| Эндпоинт | Метод | Назначение |
|-----------|-------|------------|
| `/api/v1/logs/login/` | GET | Получение логов входа текущего пользователя |

## Тестирование через Thunder Client

1. **Регистрация**
   - Метод: POST
   - URL: `http://127.0.0.1:8000/api/v1/users/register/`
   - Body (JSON):
```json
{
  "email": "user@example.com",
  "username": "username",
  "password": "password123"
}
```

2. **Активация пользователя**
   - Перейти по ссылке из письма активации, или отправить GET-запрос на:
   - URL: `http://127.0.0.1:8000/api/v1/users/activate/?u=<activation_code>`

3. **Получение JWT токена (логин)**
   - Метод: POST
   - URL: `http://127.0.0.1:8000/api/v1/users/token/`
   - Body (JSON):
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

4. **Просмотр профиля**
   - Метод: GET
   - URL: `http://127.0.0.1:8000/api/v1/users/me/`
   - Headers: `Authorization: Bearer <access_token>`

5. **Просмотр логов входа**
   - Метод: GET
   - URL: `http://127.0.0.1:8000/api/v1/logs/login/`
   - Headers: `Authorization: Bearer <access_token>`

## Админка
- Django Admin доступен по `/admin/`
- Модель `CustomUser` и `LoginLog` доступны для просмотра.

## Примечания
- Логи входов хранятся в отдельной базе данных `audit`.
- Связь логов с пользователями осуществляется через `user_email`.
- Для отправки писем необходимо настроить SMTP сервер в `.env`.

